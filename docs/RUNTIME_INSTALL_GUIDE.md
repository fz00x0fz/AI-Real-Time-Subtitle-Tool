# 运行时安装本地模型指南

## 🎯 新特性

标准版现在支持**运行时安装本地Whisper模型**，无需重新打包！

---

## ✨ 优势

### 之前的方案

❌ 需要两个版本:
- 标准版 (50-200MB) - 不支持本地模型
- 本地模型版 (1-2GB) - 支持本地模型

### 现在的方案

✅ 只需一个标准版:
- 标准版 (50-200MB) - 支持所有功能
- 按需安装本地模型
- 用户自主选择

---

## 🚀 使用方法

### 方式1: 通过配置界面安装（推荐）

1. **启动应用**
   ```bash
   双击 AI实时字幕.exe
   ```

2. **打开配置**
   - 点击窗口右上角的 ⚙ 按钮

3. **安装本地模型**
   - 在"AI服务配置"标签页
   - 查看"本地模型状态"
   - 如果显示 "⚠️ 本地模型未安装"
   - 点击 "安装本地模型" 按钮

4. **等待安装**
   - 安装过程需要3-5分钟
   - 会显示实时安装进度
   - 安装完成后提示重启

5. **重启应用**
   - 关闭并重新启动应用
   - 在AI服务中选择"本地Whisper"
   - 开始使用

### 方式2: 手动安装

如果配置界面安装失败，可以手动安装：

```bash
# 打开命令提示符
# 进入应用目录
cd "dist\AI实时字幕"

# 运行安装命令
python -m pip install openai-whisper
```

---

## 📊 安装详情

### 安装内容

| 组件 | 大小 | 说明 |
|------|------|------|
| openai-whisper | ~50MB | Whisper核心库 |
| 依赖库 | ~100MB | torch等依赖 |
| base模型 | ~74MB | 首次使用时下载 |
| **总计** | **~224MB** | 按需下载 |

### 安装时间

- 网络良好: 3-5分钟
- 网络一般: 5-10分钟
- 网络较差: 10-20分钟

### 系统要求

- ✅ Windows 10/11
- ✅ 至少2GB可用磁盘空间
- ✅ 稳定的网络连接（仅安装时）
- ✅ 管理员权限（可选）

---

## 🎨 界面说明

### 安装状态显示

**未安装**:
```
⚠️ 本地模型未安装  [安装本地模型]
```

**已安装**:
```
✅ 本地模型已安装  [重新安装]
```

### 安装进度窗口

安装时会显示一个进度窗口：

```
┌─────────────────────────────────────┐
│ 本地Whisper模型安装                  │
├─────────────────────────────────────┤
│ 本地Whisper模型可以让您在离线环境    │
│ 下使用语音识别功能。                 │
│                                     │
│ 安装内容:                            │
│ • openai-whisper 包 (约50MB)        │
│ • 首次使用时会自动下载模型           │
│                                     │
│ [进度条]                             │
│                                     │
│ [日志输出区域]                       │
│ 正在安装openai-whisper...           │
│ Collecting openai-whisper...        │
│ ...                                 │
│                                     │
│         [开始安装]  [取消]           │
└─────────────────────────────────────┘
```

---

## ✅ 安装成功标志

### 1. 状态更新

配置界面显示:
```
✅ 本地模型已安装
```

### 2. 成功提示

弹出提示框:
```
安装完成！重启应用后即可使用本地Whisper模型。
```

### 3. 可选择本地模型

重启后，AI服务下拉框中的"本地Whisper"可以正常使用。

---

## 🔧 故障排除

### 问题1: 安装失败

**错误信息**:
```
安装失败: [错误详情]
```

**解决方案**:

**方法1**: 检查网络连接
- 确保网络稳定
- 尝试使用代理

**方法2**: 手动安装
```bash
python -m pip install openai-whisper
```

**方法3**: 使用国内镜像
```bash
python -m pip install openai-whisper -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 问题2: 权限不足

**错误信息**:
```
Permission denied
```

**解决方案**:
- 以管理员身份运行应用
- 或安装到用户目录:
  ```bash
  python -m pip install --user openai-whisper
  ```

### 问题3: 磁盘空间不足

**错误信息**:
```
No space left on device
```

**解决方案**:
- 清理磁盘空间（至少2GB）
- 或更换安装位置

### 问题4: 安装后仍显示未安装

**原因**: 需要重启应用

**解决方案**:
1. 完全关闭应用
2. 重新启动
3. 打开配置查看状态

### 问题5: 首次使用时下载模型失败

**错误信息**:
```
Failed to download model
```

**解决方案**:

**方法1**: 手动下载模型
1. 访问: https://openaipublic.azureedge.net/main/whisper/models/
2. 下载 base.pt (~74MB)
3. 放到: `%USERPROFILE%\.cache\whisper\`

**方法2**: 使用代理
```bash
set HTTP_PROXY=http://proxy:port
set HTTPS_PROXY=http://proxy:port
```

---

## 💡 使用技巧

### 技巧1: 预安装模型

在首次使用前预先安装，避免等待：

1. 安装openai-whisper
2. 运行应用
3. 选择本地Whisper
4. 等待模型下载
5. 下载完成后可离线使用

### 技巧2: 切换模型

默认使用base模型，可以切换到其他模型：

编辑 `transcription_service.py`:
```python
self.model = whisper.load_model("small")  # 更准确
```

### 技巧3: 卸载模型

如需卸载释放空间：

```bash
# 卸载openai-whisper
python -m pip uninstall openai-whisper

# 删除模型文件
rmdir /s /q %USERPROFILE%\.cache\whisper
```

### 技巧4: 离线安装

如果目标机器无网络：

1. 在有网络的机器上下载:
   ```bash
   pip download openai-whisper -d whisper_packages
   ```

2. 复制 `whisper_packages` 文件夹到目标机器

3. 在目标机器上安装:
   ```bash
   pip install --no-index --find-links=whisper_packages openai-whisper
   ```

---

## 📦 打包说明

### 标准版打包

现在只需打包标准版即可：

```bash
build.bat
```

输出:
- 体积: 50-200MB
- 支持: 所有AI服务（包括本地模型）
- 用户可按需安装本地模型

### 不再需要本地模型版

~~`build_with_whisper.bat`~~ (可选)

标准版已支持运行时安装，无需单独打包本地模型版。

---

## 🎯 推荐流程

### 对于开发者

1. **只打包标准版**
   ```bash
   build.bat
   ```

2. **在说明文档中告知用户**
   - 可以按需安装本地模型
   - 通过配置界面一键安装

### 对于用户

1. **下载标准版**
   - 体积小，下载快

2. **根据需求选择**
   - 使用云端API → 直接使用
   - 需要离线 → 安装本地模型

3. **一键安装**
   - 打开配置界面
   - 点击"安装本地模型"
   - 等待完成

---

## 📊 方案对比

### 之前: 两个版本

| 版本 | 体积 | 打包时间 | 用户选择 |
|------|------|---------|---------|
| 标准版 | 50-200MB | 5-10分钟 | 不支持本地模型 |
| 本地模型版 | 1-2GB | 10-30分钟 | 支持本地模型 |

**问题**:
- ❌ 需要维护两个版本
- ❌ 用户需要选择下载哪个
- ❌ 本地模型版体积大

### 现在: 一个版本

| 版本 | 体积 | 打包时间 | 用户选择 |
|------|------|---------|---------|
| 标准版 | 50-200MB | 5-10分钟 | 支持所有功能 |

**优势**:
- ✅ 只需一个版本
- ✅ 体积小，易分发
- ✅ 用户按需安装
- ✅ 灵活性高

---

## 🎉 总结

### 新特性

- ✅ 标准版支持运行时安装本地模型
- ✅ 图形化安装界面
- ✅ 实时安装进度显示
- ✅ 自动状态检测
- ✅ 一键安装/重装

### 优势

- ✅ 减小打包体积
- ✅ 简化版本管理
- ✅ 提高用户体验
- ✅ 按需下载

### 使用建议

1. **开发者**: 只打包标准版
2. **用户**: 按需安装本地模型
3. **推广**: 强调灵活性和易用性

---

**开始使用**: 打包标准版，让用户自主选择是否安装本地模型！ 🚀
